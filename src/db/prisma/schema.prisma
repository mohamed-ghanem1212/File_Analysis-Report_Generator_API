// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "./src/db/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum AnalysisStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum TriggerType {
  MANUAL
  SCHEDULED
  WEBHOOK
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Category {
  CODE_SMELL
  BUG_RISK
  PERFORMANCE
  SECURITY
  STYLE
  COMPLEXITY
  DUPLICATION
  TECHNICAL_DEBT
}

enum MetricType {
  CODE_COVERAGE
  DUPLICATION
  COMPLEXITY
  SECURITY_VULNERABILITIES
  STYLE_VIOLATIONS
  TECHNICAL_DEBT
}

enum ReportType {
  SUMMARY
  DETAILED
  EXECUTIVE
  COMPARISON
  TREND
}

enum Format {
  JSON
  PDF
  HTML
  MARKDOWN
}

enum Status {
  IDENTIFIED
  ACKNOWLEDGED
  PLANNED
  IN_PROGRESS
  RESOLVED
  WONT_FIX
}

enum Action {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

model User {
  id        String      @id @default(uuid())
  email     String      @unique
  username  String
  password  String
  role      Role        @default(USER)
  projects  Project[]
  Analyses  Analysis[]
  comments  Comment[]
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt()
  issues    Issue[]
  reports   Report[]
  debtItems Debt_Item[]
  auditLogs Audit_log[]
}

model Project {
  id            String        @id @default(uuid())
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  name          String
  repositoryUrl String?
  visibility    Visibility    @default(PRIVATE)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt()
  settings      Json          @default("{}")
  analyses      Analysis[]
  metrics       Metric[]
  projectRules  ProjectRule[]
  debtItems     Debt_Item[]
}

model Analysis {
  id              String         @id @default(uuid())
  project         Project        @relation(fields: [projectId], references: [id])
  projectId       String
  user            User           @relation(fields: [userId], references: [id])
  userId          String
  status          AnalysisStatus @default(PENDING)
  trigger         TriggerType    @default(MANUAL)
  summary         Json
  totalFiles      Int
  totalLines      Int
  issuesFound     Int
  complexityScore Float
  startedAt       DateTime       @default(now())
  completedAt     DateTime?
  files           File[]
  issues          Issue[]
  metrics         Metric[]
  reports         Report[]
}

model File {
  id              String   @id @default(uuid())
  analysis        Analysis @relation(fields: [analysisId], references: [id])
  analysisId      String
  filePath        String
  fileName        String
  fileHash        String
  linesOfCode     Int
  lineBlank       Int
  lineComment     Int
  issuesFound     Int
  complexityScore Float
  issues          Issue[]
}

model Issue {
  id              String      @id @default(uuid())
  file            File        @relation(fields: [fileId], references: [id])
  fileId          String
  analysis        Analysis    @relation(fields: [analysisId], references: [id])
  analysisId      String
  category        Category    @default(CODE_SMELL)
  severity        Severity    @default(LOW)
  title           String
  description     String
  lineNumber      Int
  columnNumber    Int
  codeSnippet     String
  suggestion      String
  isResolved      Boolean     @default(false)
  resolvedAt      DateTime?
  resolvedBy      User?       @relation(fields: [resolvedById], references: [id])
  resolvedById    String?
  resolutionNotes String?
  debtItems       Debt_Item[]
}

model Metric {
  id         String     @id @default(uuid())
  analysis   Analysis   @relation(fields: [analysisId], references: [id])
  analysisId String
  project    Project    @relation(fields: [projectId], references: [id])
  projectId  String
  name       String
  value      Float
  unit       String
  type       MetricType
  metaData   Json
}

model Report {
  id          String     @id @default(uuid())
  analysis    Analysis   @relation(fields: [analysisId], references: [id])
  analysisId  String
  user        User       @relation(fields: [userId], references: [id])
  userId      String
  reportType  ReportType @default(SUMMARY)
  format      Format     @default(JSON)
  content     Json
  filePath    String?
  downloadUrl String?
  expiresAt   DateTime?
}

model Rule {
  id           String        @id @default(uuid())
  ruleId       String        @unique
  name         String
  description  String
  severity     Severity      @default(LOW)
  category     Category      @default(CODE_SMELL)
  isActive     Boolean       @default(true)
  config       Json
  language     String
  projectRules ProjectRule[]
}

model ProjectRule {
  id               String    @id @default(uuid())
  project          Project   @relation(fields: [projectId], references: [id])
  projectId        String
  rule             Rule      @relation(fields: [ruleId], references: [id])
  ruleId           String
  isEnabled        Boolean   @default(true)
  severityOverride Severity?
  configOverride   Json?
}

model Debt_Item {
  id              String    @id @default(uuid())
  project         Project   @relation(fields: [projectId], references: [id])
  projectId       String
  issue           Issue     @relation(fields: [issueId], references: [id])
  issueId         String
  title           String
  description     String
  priority        Severity  @default(MEDIUM)
  status          Status
  estimatedEffort Int
  businessImpact  Float
  assingedTo      User?     @relation(fields: [assignedToId], references: [id])
  assignedToId    String?
  dueDate         DateTime?
}

model Comment {
  id              String  @id @default(uuid())
  user            User    @relation(fields: [userId], references: [id])
  userId          String
  commentableType String
  commentableId   String
  content         String
  parentId        String? @default(uuid())
}

model Audit_log {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  entityTybe String
  entityId   String
  action     String
  oldValue   Json
  newValue   Json
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
}
